# java21-crypto-on-and-off-ramp

## Open crypto 全流程架構圖

```
┌──────────────────────────────┐
│        前端頁面               │
│  用戶點擊購買/賣出按鈕          │
└─────────────┬────────────────┘
              │
              ▼
┌──────────────────────────────┐
│      嵌入 VeVeloPay Widget    │
│  iframe 參數包括 widgetId、    │
│  tradeType、fiatCoin、        │
│  cryptoCoin、walletAddress    │
│  並附上簽名 sign               │
└─────────────┬────────────────┘
              │
              ▼
┌──────────────────────────────┐
│     VeVeloPay 伺服器          │
│  1️⃣ 創建訂單                  │
│  2️⃣ 返回訂單狀態 (pending)     │
│  3️⃣ 發送 webhook 到後端        │
└─────────────┬────────────────┘
              │
              ▼
┌──────────────────────────────┐
│   你的後端系統 webhook URL     │
│  1️⃣ 接收 JSON payload         │
│  2️⃣ 驗證簽名 sign             │
│  3️⃣ 更新本地訂單狀態            │
│  4️⃣ 回覆 "ok" 給 VeVeloPay    │
└─────────────┬────────────────┘
              │
              ▼
┌──────────────────────────────────────────────┐
│     訂單狀態處理流程                            │
│  - pending_payment → 等待付款                  │
│  - payment_pending_transfer → 處理中          │
│  - crypto_transferred → 區塊鏈轉帳已提交        │
│  - completed → 訂單完成                        │
│  - cancelled / declined / expired → 失敗或取消 │
└─────────────┬────────────────────────────────┘
              │
              ▼
┌────────────────────────────────────────┐
│ 可選：查詢 Order API                     │
│ GET /sellOrder/query/{merchantOrderId} │
│ 獲取最新狀態 blockTxHash、coinAmount     │
└────────────────────────────────────────┘
```

## AlchemyPay 全流程架構圖

```

                    ┌─────────────────────┐
                    │   用戶前端 / App     │
                    └─────────┬───────────┘
                              │
                              │ 選擇幣種 / 法幣 / 金額
                              │
                              ▼
                    ┌─────────────────────┐
                    │    後端 Server       │
                    └─────────┬───────────┘
                              │
            ┌─────────────────┴─────────────────┐
            │                                   │
            ▼                                   ▼
┌─────────────────────┐             ┌─────────────────────┐
│ 支援幣種 /法幣查詢     │             │   即時報價 / 匯率     │
│ / SupportedCoins    │             │     / Quote API     │
└─────────┬───────────┘             └─────────┬───────────┘
          │                                   │
          ▼                                   ▼
┌─────────────────────┐             ┌─────────────────────┐
│      建立訂單        │             │      計算支付金額     │
│ / Create Order API   │◀──────────▶│   (含手續費 / 匯率)   │
└─────────┬───────────┘             └─────────┬───────────┘
          │                                   │
          ▼                                   ▼
┌──────────────────────┐             ┌─────────────────────┐
│  回傳支付鏈接 / QR     │             │    Body MD5 / Sign  │
│  redirectUrl / fail  │             │  (SHA1 / HMAC / MD5)│
│  RedirectUrl / Fail  │             └─────────────────────┘
└─────────┬────────────┘
          │
          ▼
┌─────────────────────┐
│   用戶付款 (前端)     │
└─────────┬───────────┘
          │
┌─────────┴─────────┐
│                   │
▼                   ▼
成功付款            付款失敗 / 超時
redirectUrl         failRedirectUrl / Pending
(SUCCESS)           (FAILED / TIMEOUT)

            │
            ▼
┌─────────────────────┐
│  AlchemyPay Webhook │
│  (訂單狀態回調)       │
│  status: SUCCESS    │
│  status: FAILED     │
│  merchantOrderNo    │
│  returnCode / Msg   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ 後端 Server 處理回調  │
│ - 驗簽 (Signature)   │
│ - 訂單狀態更新        │
│ - 失敗重試邏輯        │
│ - 部分退款 / 對帳     │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ 後端 / 前端顯示結果    │
│ - 成功頁 / 失敗頁     │
│ - 訂單歷史 / 對帳報表  │
└─────────────────────┘
```
